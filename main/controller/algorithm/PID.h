#pragma once
//******************************************************************************
// Секция include
//******************************************************************************

//******************************************************************************
// Секция определения констант
//******************************************************************************

//******************************************************************************
// Секция определения типов
//******************************************************************************
typedef struct 
{
    struct 
    {
        float Kp;       // Пропорциональный коэффициент
        float Ki;       // Интегральный коэффициент
        float Kd;       // Дифференциальный коэффициент

        float out_min;  // Минимальное значение выхода (ограничение)
        float out_max;  // Максимальное значение выхода (ограничение)

        float integr_min;  // Минимальное значение интеграла (anti-windup)
        float integr_max;  // Максимальное значение интеграла (anti-windup)

        // Фильтр производной части
        // D-компонента ПИД очень чувствительна к шуму измерения.
        // Чтобы уменьшить пики и дерганья, производная фильтруется скользящим средним:
        // prev_deriv = prev_deriv + d_filter * (deriv - prev_deriv)
        // d_filter ∈ [0..1]:
        //   0   → сильное сглаживание, реакция медленная
        // 0.05  → слабое сглаживание
        // 0.1-0.2 → среднее сглаживание, шум почти убран
        //   1   → почти нет фильтра, берётся чистая производная
        float d_filter;  
    } param;

    struct 
    {
        float prev_error;   // Предыдущая ошибка, нужна для расчёта производной
        float integral;     // Сумма интеграла ошибки
        float prev_deriv;   // Отфильтрованная производная ошибки
    } status;
} PID_t;
//******************************************************************************
// Секция определения глобальных переменных
//******************************************************************************

//******************************************************************************
// Секция прототипов глобальных функций
//******************************************************************************
inline void PID_Init(PID_t *pid, float Kp, float Ki, float Kd);
float PID_calc(PID_t *pid, float setpoint, float measurement, float dt);

// --- Kp ---
void PID_SetKp(PID_t *pid, float Kp);
float PID_GetKp(PID_t *pid);

// --- Ki ---
void PID_SetKi(PID_t *pid, float Ki);
float PID_GetKi(PID_t *pid);

// --- Kd ---
void PID_SetKd(PID_t *pid, float Kd);
float PID_GetKd(PID_t *pid);

// --- Установка / получение всех Kp, Ki, Kd ---
void PID_SetPID(PID_t *pid, float Kp, float Ki, float Kd);
void PID_GetPID(PID_t *pid, float *Kp, float *Ki, float *Kd);

// --- Ограничения выхода ---
void PID_SetOutputLimits(PID_t *pid, float out_min, float out_max);
void PID_GetOutputLimits(PID_t *pid, float *out_min, float *out_max);

// --- Ограничения интеграла ---
void PID_SetIntegralLimits(PID_t *pid, float integr_min, float integr_max);
void PID_GetIntegralLimits(PID_t *pid, float *integr_min, float *integr_max);

// --- Фильтр производной части ---
void PID_SetDFilter(PID_t *pid, float d_filter);
float PID_GetDFilter(PID_t *pid);
//******************************************************************************
// Секция определения макросов
//******************************************************************************

//******************************************************************************
// ENF OF FILE
//******************************************************************************