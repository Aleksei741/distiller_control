//******************************************************************************
//include
//******************************************************************************
#include "PID.h"
//******************************************************************************
// Constants
//******************************************************************************

//******************************************************************************
// Type
//******************************************************************************

//******************************************************************************
// Variables
//******************************************************************************
//------------------------------------------------------------------------------
// Global
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Local Variable
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Local Class
//------------------------------------------------------------------------------

//******************************************************************************
// Function prototype
//******************************************************************************

//******************************************************************************
// Function
//******************************************************************************
float PID_calc(PID_t *pid, float setpoint, float measurement, float dt)
{
    if (dt <= 0) dt = 0.001f;

    float error = setpoint - measurement;

    // --- Интеграл (c анти-насыщением)
    pid->status.integral += error * dt;
    if (pid->status.integral > pid->param.integr_max) pid->status.integral = pid->param.integr_max;
    if (pid->status.integral < pid->param.integr_min) pid->status.integral = pid->param.integr_min;

    // --- Производная (с фильтром)
    float deriv = (error - pid->status.prev_error) / dt;
    pid->status.prev_deriv = pid->status.prev_deriv + pid->param.d_filter * (deriv - pid->status.prev_deriv);

    pid->status.prev_error = error;

    // --- Выход
    float out =
        pid->param.Kp * error +
        pid->param.Ki * pid->status.integral +
        pid->param.Kd * pid->status.prev_deriv;

    // --- Ограничение выхода
    if (out > pid->param.out_max) out = pid->param.out_max;
    if (out < pid->param.out_min) out = pid->param.out_min;

    return out;
}
//------------------------------------------------------------------------------
inline void PID_Init(PID_t *pid, float Kp, float Ki, float Kd)
{
    pid->param.Kp = Kp;
    pid->param.Ki = Ki;
    pid->param.Kd = Kd;

    pid->param.out_min = -1000.0f;
    pid->param.out_max = 1000.0f;

    pid->param.integr_min = -500.0f;
    pid->param.integr_max = 500.0f;

    pid->param.d_filter = 0.1f;

    pid->status.prev_error = 0.0f;
    pid->status.integral = 0.0f;
    pid->status.prev_deriv = 0.0f;
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Установка и получение Kp -------------------
//------------------------------------------------------------------------------
void PID_SetKp(PID_t *pid, float Kp) { pid->param.Kp = Kp; }
float PID_GetKp(PID_t *pid) { return pid->param.Kp; }

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Установка и получение Ki -------------------
//------------------------------------------------------------------------------
void PID_SetKi(PID_t *pid, float Ki) { pid->param.Ki = Ki; }
float PID_GetKi(PID_t *pid) { return pid->param.Ki; }

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Установка и получение Kd -------------------
//------------------------------------------------------------------------------
void PID_SetKd(PID_t *pid, float Kd) { pid->param.Kd = Kd; }
float PID_GetKd(PID_t *pid) { return pid->param.Kd; }

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Установка и получение всех Kp, Ki, Kd -------------------
//------------------------------------------------------------------------------
void PID_SetPID(PID_t *pid, float Kp, float Ki, float Kd) 
{
    pid->param.Kp = Kp;
    pid->param.Ki = Ki;
    pid->param.Kd = Kd;
}
//------------------------------------------------------------------------------
void PID_GetPID(PID_t *pid, float *Kp, float *Ki, float *Kd) 
{
    if (Kp) *Kp = pid->param.Kp;
    if (Ki) *Ki = pid->param.Ki;
    if (Kd) *Kd = pid->param.Kd;
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Установка и получение out_min, out_max -------------------
//------------------------------------------------------------------------------
void PID_SetOutputLimits(PID_t *pid, float out_min, float out_max) 
{
    pid->param.out_min = out_min;
    pid->param.out_max = out_max;
}
//------------------------------------------------------------------------------
void PID_GetOutputLimits(PID_t *pid, float *out_min, float *out_max) 
{
    if (out_min) *out_min = pid->param.out_min;
    if (out_max) *out_max = pid->param.out_max;
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Ограничения интеграла -------------------
//------------------------------------------------------------------------------
void PID_SetIntegralLimits(PID_t *pid, float integr_min, float integr_max) 
{
    pid->param.integr_min = integr_min;
    pid->param.integr_max = integr_max;
}
//------------------------------------------------------------------------------
void PID_GetIntegralLimits(PID_t *pid, float *integr_min, float *integr_max) 
{
    if (integr_min) *integr_min = pid->param.integr_min;
    if (integr_max) *integr_max = pid->param.integr_max;
}

//------------------------------------------------------------------------------
//------------------------------------------------------------------------------
// ------------------- Фильтр производной части -------------------
//------------------------------------------------------------------------------
void PID_SetDFilter(PID_t *pid, float d_filter) { pid->param.d_filter = d_filter; }
float PID_GetDFilter(PID_t *pid) { return pid->param.d_filter; }
//------------------------------------------------------------------------------
