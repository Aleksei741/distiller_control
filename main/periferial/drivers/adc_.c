//******************************************************************************
//include
//******************************************************************************
#include "adc_.h"
#include "esp_log.h"          // ESP_LOGI
#include "driver/adc.h"
#include "esp_log.h"
#include <math.h>
#include <stdlib.h>

//******************************************************************************
// Constants
//******************************************************************************

//******************************************************************************
// Type
//******************************************************************************

//******************************************************************************
// Variables
//******************************************************************************
//------------------------------------------------------------------------------
// Global
//------------------------------------------------------------------------------
static const char* TAG = "[ADC_]";
//------------------------------------------------------------------------------
// Local Variable
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
// Local Class
//------------------------------------------------------------------------------

//******************************************************************************
// Function prototype
//******************************************************************************

//******************************************************************************
// Function
//******************************************************************************
void adc_init(adc_module_t* module)
{
    for(int i=0; i<module->channel_count; i++){
        adc1_config_width(ADC_WIDTH_BIT_12);
        adc1_config_channel_atten(module->channels[i].adc_channel, ADC_ATTEN_DB_11);
        ESP_LOGI(TAG, "Channel %s initialized", module->channels[i].name);
    }
}
//------------------------------------------------------------------------------
void adc_deinit(adc_module_t* module)
{
    // Сейчас ничего не требуется для ADC1
    (void)module;
}
//------------------------------------------------------------------------------
void adc_read_rms(adc_module_t* module, int channel_index, int sample_count, int sample_period_ms, float* rms_result)
{
    if(channel_index >= module->channel_count) return;

    int32_t sum_sq = 0;
    for(int i=0; i<sample_count; i++){
        int val = adc1_get_raw(module->channels[channel_index].adc_channel);
        float voltage = val * 3.3f / 4095.0f;   // перевод в вольты
        sum_sq += voltage * voltage;
        vTaskDelay(pdMS_TO_TICKS(sample_period_ms));
    }

    *rms_result = sqrtf(sum_sq / sample_count);
    ESP_LOGI(TAG, "RMS %s = %.3f V", module->channels[channel_index].name, *rms_result);
}
//------------------------------------------------------------------------------
